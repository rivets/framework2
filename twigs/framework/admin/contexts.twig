{% extends '@util/page.twig' %}

{% import '@util/formmacro.twig' as f %}

{% macro tick(val, class) %}
<i class="{{class}} fa fa-toggle-{% if val %}on{% else %}off{% endif %}"></i>
{% endmacro tick %}

{% import _self as h %}

{% block scripts %}
    <script src="{{assets}}/js/util.js"></script>
{% endblock scripts %}

{% block onload %}
    $('#ncform').on('submit', false)
    $('#addb').on('click', function(e){
        e.preventDefault()
        var pn = $('#ncname').val()
	if (!pn.match(/^[a-zA-Z][a-zA-Z0-9]*$/))
	{
	    bootbox.alert('&quot;'+pn+'&quot; is not a valid context name. Letters and numbers only')
	    return
	}
	var sp = null
	var error = false
	$('.cname').each(function(e){
	    var t = $(this).text()
	    if (t == pn)
	    {
	        error = true
	        return false
	    }
	    if (t > pn)
	    {
		sp = $(this)
		return false
	    }
	})
	if (error)
	{
	    bootbox.alert('That context already exists')
	    return
	}
	$('#ncontext').modal('hide')
	var htm = '<tr><td>'+pn+'</td><td>'+mktoggle('fixed', 0)+'</td><td><i class="delb fa fa-trash-o"></i></td></tr>'
	var nx
	if (sp == null)
	{
	    nx = $(htm).appendTo($('#ctab tbody'))
	}
	else
	{
	    nx = $(htm).insertBefore(sp.parent())
	}
	$.post('{{base}}/ajax/bean/rolecontext/', {
		name : pn,
	}).done(function(data){
	       nx.data('id', data);
	}).fail(function(){
            bootbox.alert('Creation of new RoleContext failed');
        });
    })
    $('#ctab').on('click', function(e){
        var x = $(e.target)
	if (x.hasClass('delb'))
	{
            dodelbean(e, x, 'rolecontext');
	}
	else if (x.hasClass('fixed'))
	{
	    dotoggle(e, x, 'rolecontext', 'fixed')
	}
    })
    $('#ncontext').on('show.bs.modal', function(e){
	$('#ncform input').val('')
    })
{% endblock onload %}

{% if not page is defined %}
    {% set page = 1 %}
    {% set pagesize = 10 %}
{% endif %}

{% set pages = (siteinfo.count('rolecontext') + pagesize)/pagesize %}

{% block header %}
    <section class="col-md-12">
	<h1>Role Contexts</h1>
    </section>
{% endblock header %}

{% block main %}
    <section class="row">
        <article class="ml-auto col-md-8 mr-auto">
            {% include '@util/paginate.twig' with { page : page, pagesize: pagesize, pages: pages} %}
            <table class="table table-striped table-hover" id="ctab">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Fixed</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in siteinfo.contexts(page, pagesize) %}
                    <tr data-id="{{c.id}}">
                        <td class="cname">{{c.name}}</td>
                        <td>{{h.tick(c.fixed, 'fixed')}}</td>
                        <td>{% if c.fixed %}&nbsp;{% else %}<i class="delb fa fa-trash-o"></i>{% endif %}</td>
                    </tr>
                    {% else %}
                        <tr><td colspan="3">No contexts defined</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            {% include '@util/paginate.twig' with { page : page, pagesize: pagesize, pages: pages} %}
            <p><button class="btn btn-primary" data-toggle="modal" data-target="#ncontext" type="button">Add Context</button></p>
        </article>
    </section>
    <div class="modal fade" id="ncontext" aria-labelledby="ncontext" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">New Context</h4>
                </div>
                <div class="modal-body">
                    <form action="#" method="POST" id="nrform">
                        {{f.text({label: 'Name', ph: 'Context Name', required: TRUE})}}
<!--                        <div class="form-group">
                            <label for="ncname">Name</label>
                            <input type="text" class="form-control" id="ncname" placeholder="context name" required="required"/>
                        </div>-->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="addb">Add</button>
                </div>
            </div>
        </div>
    </div>
{% endblock main %}

{% block pagefooter %}
{# I don't want a footer #}
{% endblock pagefooter %}
